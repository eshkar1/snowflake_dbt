with tenants_us_final as (
    select * from {{ ref('tenants_us_final')}}
)


select
    root,
    parent_global_id,
    parent_name,
    tenant_global_id,
    tenant_name,
    registration_timestamp,
    domain,
    OWNER_NAME,
	OWNER_EMAIL,
    partner_pricing,
    plan_id,
    finance_db.billing_sch.plan_id2name_fn(plan_id) as plan_name,
    case plan_id
        when 1 then 'Phishing Simulation and Training'
        when 2 then 'Starter'
        when 3 then 'Core'
        when 4 then 'Email Protect'
        when 5 then 'Complete Protect'
        when 6 then 'IRONSCALES Protect'
        else ifnull(to_varchar(plan_id), ''No_Plan'')
    end as plan_name,
    premium_id,
    finance_db.billing_sch.premium_id2name_fn(premium_id) as premium_name,
    case premium_id
        when 1 then ''NINJIO''
        when 3 then ''Habitu8''
        when 4 then ''Cybermaniacs Videos''
        when 5 then ''Wizer''
        when 6 then ''IRONSCALES''
        else ifnull(to_varchar(premium_id), ''No Premium'')
    end as premium_name,
    plan_expiry,
    incident_management,
    security_awareness_training,
    simulation_and_training_bundle,
    simulation_and_training_bundle_plus,
    ai_empower_bundle,
    themis_co_pilot,  
    ato,
    teams_protection,
    file_scanning,
    link_scanning,    
    multi_tenancy,
    licensed_profiles,
    active_profiles,
    shared_profiles,
    trial_plan_id,
    finance_db.billing_sch.plan_id2name_fn(trial_plan_id) as trial_plan_name,
    case trial_plan_id
        when 1 then 'Phishing Simulation and Training'
        when 2 then 'Starter'
        when 3 then 'Core'
        when 4 then 'Email Protect'
        when 5 then 'Complete Protect'
        when 6 then 'IRONSCALES Protect'
        else ifnull(to_varchar(trial_plan_id), ''No_Plan'')
    end as trial_plan_name,
    trial_premium_id,
    finance_db.billing_sch.premium_id2name_fn(trial_premium_id) as trial_premium_name,
    case trial_premium_id
        when 1 then ''NINJIO''
        when 3 then ''Habitu8''
        when 4 then ''Cybermaniacs Videos''
        when 5 then ''Wizer''
        when 6 then ''IRONSCALES''
        else ifnull(to_varchar(trial_premium_id), ''No Premium'')
    end as trial_premium_name,
    trial_plan_expiry,
    depth,
    approved,
    tree_key,
    roundup_timestamp,
    finance_db.billing_sch.billing_status_fn(plan_id, trial_plan_id, plan_expiry, trial_plan_expiry, roundup_timestamp) as billing_status
from
    tenants_us_final
    -- ironscales_us_db.rr_prod_sch.tenants_vw
union
select
    root,
    parent_global_id,
    parent_name,
    tenant_global_id,
    tenant_name,
    registration_timestamp,
    domain,
    OWNER_NAME,
	OWNER_EMAIL,
    partner_pricing,
    plan_id,
    finance_db.billing_sch.plan_id2name_fn(plan_id) as plan_name,
    case plan_id
        when 1 then 'Phishing Simulation and Training'
        when 2 then 'Starter'
        when 3 then 'Core'
        when 4 then 'Email Protect'
        when 5 then 'Complete Protect'
        when 6 then 'IRONSCALES Protect'
        else ifnull(to_varchar(plan_id), ''No_Plan'')
    end as plan_name,
    premium_id,
    finance_db.billing_sch.premium_id2name_fn(premium_id) as premium_name,
    case premium_id
        when 1 then ''NINJIO''
        when 3 then ''Habitu8''
        when 4 then ''Cybermaniacs Videos''
        when 5 then ''Wizer''
        when 6 then ''IRONSCALES''
        else ifnull(to_varchar(premium_id), ''No Premium'')
    end as premium_name,
    plan_expiry,
    incident_management,
    security_awareness_training,
    simulation_and_training_bundle,
    simulation_and_training_bundle_plus,
    ai_empower_bundle,
    themis_co_pilot,  
    ato,
    teams_protection,
    file_scanning,
    link_scanning,    
    multi_tenancy,
    licensed_profiles,
    active_profiles,
    shared_profiles,
    trial_plan_id,
    finance_db.billing_sch.plan_id2name_fn(trial_plan_id) as trial_plan_name,
    case trial_plan_id
        when 1 then 'Phishing Simulation and Training'
        when 2 then 'Starter'
        when 3 then 'Core'
        when 4 then 'Email Protect'
        when 5 then 'Complete Protect'
        when 6 then 'IRONSCALES Protect'
        else ifnull(to_varchar(trial_plan_id), ''No_Plan'')
    end as trial_plan_name,
    trial_premium_id,
    finance_db.billing_sch.premium_id2name_fn(trial_premium_id) as trial_premium_name,
    case trial_premium_id
        when 1 then ''NINJIO''
        when 3 then ''Habitu8''
        when 4 then ''Cybermaniacs Videos''
        when 5 then ''Wizer''
        when 6 then ''IRONSCALES''
        else ifnull(to_varchar(trial_premium_id), ''No Premium'')
    end as trial_premium_name,
    trial_plan_expiry,
    depth,
    approved,
    tree_key,
    roundup_timestamp,
    finance_db.billing_sch.billing_status_fn(plan_id, trial_plan_id, plan_expiry, trial_plan_expiry, roundup_timestamp) as billing_status
from
    secondary_eu_db.tenants_sch.tenants_tbl